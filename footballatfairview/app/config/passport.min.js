var FacebookStrategy,User,configAuth,util;FacebookStrategy=require("passport-facebook").Strategy,User=require("../models/user"),configAuth=require("./auth"),util=require("util"),module.exports=function(e){e.serializeUser(function(e,o){o(null,e.id)}),e.deserializeUser(function(e,o){User.findById(e,function(e,t){o(e,t)})}),e.use(new FacebookStrategy({clientID:configAuth.facebookAuth.clientID,clientSecret:configAuth.facebookAuth.clientSecret,callbackURL:configAuth.facebookAuth.callbackURL,profileFields:["id","emails","name","gender","picture.type(large)"]},function(e,o,t,n){process.nextTick(function(){User.findOne({"facebook.id":t.id},function(o,i){var a;return o?n(o):i?n(null,i):(a=new User,a.facebook.id=t.id,a.facebook.photos=t.photos,a.facebook.token=e,a.facebook.full_name=t._json.first_name+" "+t._json.last_name,a.facebook.first_name=t._json.first_name,a.facebook.last_name=t._json.last_name,a.facebook.email=t._json.email,a.status="active",a.save(function(e){if(e)throw e;return n(null,a)}),void 0)})})}))};
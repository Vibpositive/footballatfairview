var List,User,_,isLoggedIn,moment,nonSecurePaths;List=require("../app/models/list"),User=require("../app/models/user"),moment=require("moment"),_=require("underscore"),process.env.NODE_ENV="development",nonSecurePaths=["/","/profile","/auth/facebook","/auth/facebook/callback","/profile/edit/phoneNumber","/profile/crud/details","/cp/matches"],isLoggedIn=function(e,t,o){return e.isAuthenticated()?o():void t.redirect("/")},module.exports=function(e,t){e.use(function(e,t,o){var i,n,r,s;try{void 0!==e.user&&(e.user.role="guest")}catch(r){i=r,console.log(i)}if(_.contains(nonSecurePaths,e.path))return o();try{if(e.user.id)return User.findOne({_id:e.user.id},function(e,i){return e?(console.log(e),!1):"000-000-0000"===i.phone?t.redirect("/profile"):o()})}catch(s){return n=s,o()}}),e.get("/",function(e,t){e.session.userId="Vibpositive",t.render("login.ejs",{message:e.flash("loginMessage"),title:"Login page"})}),e.get("/index",isLoggedIn,function(e,t){List.find({},function(o,i){return o?console.log(o):void t.render("matches/index.ejs",{message:e.flash("loginMessage"),lists:i,user:e.user,moment:moment,title:"List"})})}),e.get("/logout",function(e,t){e.logout(),t.redirect("/")}),e.get("/auth/facebook",t.authenticate("facebook",{scope:"email"})),e.get("/auth/facebook/callback",t.authenticate("facebook",{successRedirect:"/index",failureRedirect:"/"})),e.get("/logout",function(e,t){e.logout(),t.redirect("/")})};
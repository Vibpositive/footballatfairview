var List,ObjectId,User,_,addMatchToUserList,isLoggedIn,moment,uuid;List=require("../models/list"),User=require("../models/user"),moment=require("moment"),uuid=require("node-uuid"),_=require("underscore"),ObjectId=require("mongodb").ObjectID,isLoggedIn=function(e,s,t){return e.isAuthenticated()?t():void s.redirect("/")},addMatchToUserList=function(e,s,t,n){return"push"===t?User.update({_id:e.id},{$addToSet:{matches:s}},function(e,s){return e?{message:e}:s>0?{message:"ok"}:{message:"0 rows affected"}}):User.findByIdAndUpdate({_id:e.id},{$pull:{matches:s}},function(e,s){return e?{message:e}:{message:s}})},module.exports=function(e){e.get("/matches",isLoggedIn,function(e,s){List.find({},function(t,n){return t?console.log(t):void s.render("matches/index.ejs",{message:e.flash("loginMessage"),lists:n,user:e.user,moment:moment,title:"Matches List"})})}),e.post("/matches/views/playerslist",isLoggedIn,function(e,s){return List.findOne({_id:e.body.list_id},function(t,n){return t?void s.send(t):void s.render("matches/names/names_list.ejs",{message:e.flash("loginMessage"),list:n,user:e.user,moment:moment,title:"Matches index"})})}),e.post("/matches/addusertomatch",function(e,s){var t;return t=e.body.list_id,User.find({},function(e,n){return _.each(n,function(e){List.update({_id:t},{$addToSet:{names:{player_id:e._id,datetime:"",last_name:e.facebook.last_name,first_name:e.facebook.first_name,full_name:e.facebook.full_name,phone:e.phone,status:"playing"}}},function(e,s){})}),s.send("ok")})}),e.post("/matches/participate",isLoggedIn,function(e,s){var t,n,i,a,d,o,r;return r=new ObjectId(e.user.id),t="date",a=e.user.facebook.last_name,n=e.user.facebook.first_name,i=e.user.facebook.first_name+" "+e.user.facebook.last_name,d=e.body.list_id,o=e.user.phone,"true"===e.body.player_status?(addMatchToUserList(e.user,d,"push"),List.update({_id:d},{$addToSet:{names:{player_id:r,datetime:t,last_name:a,first_name:n,full_name:i,status:"playing",phone:o}}},function(e,t){return e?s.send("err: "+String(e)):t>0?s.json({message:"ok"}):void s.json({message:"0 rows affected"})})):(addMatchToUserList(e.user,d,"pull"),List.findByIdAndUpdate({_id:d},{$pull:{names:{full_name:i}}},function(e,t){return e?s.send("err: "+String(e)):s.send(t)}))}),e.get("/matches/match/:listid",isLoggedIn,function(e,s){var t;t=e.params.listid,List.find({_id:t,names:{$elemMatch:{full_name:e.user.facebook.full_name}}},function(n,i){var a;return a=!(i.length<=0),List.findOne({_id:t},function(t,n){return t?void console.log(t):void s.render("matches/match_details.ejs",{message:e.flash("loginMessage"),list:n,match_date:moment(n.date).format("dddd, MMMM Do YYYY, h : mm : ss a"),user:e.user,player_on_list:a,moment:moment,disabled:"deactivate"===n.list_status?"disabled":"",title:"Match"})})})}),e.get("/matches/match/details/:listid",isLoggedIn,function(e,s){List.findOne({_id:e.params.listid},function(t,n){return t?void console.log(t):void s.render("matches/match_list_details.ejs",{message:e.flash("loginMessage"),list:n,match_date:moment(n.date).format("dddd, MMMM Do YYYY, h : mm : ss a"),user:e.user,title:"Match: details"})})}),e.get("/matches/create",isLoggedIn,function(e,s){s.render("matches/create.ejs",{title:"Create a match"})}),e.get("/matches/edit",isLoggedIn,function(e,s){return List.find({},function(t,n){return t?void s.send(t):void s.render("matches/list.ejs",{message:e.flash("loginMessage"),lists:n,user:e.user,moment:moment,title:"Matches index"})})}),e.get("/matches/edit/:listid",isLoggedIn,function(e,s,t){var n;return n=e.params.listid,List.findOne({_id:n},{},function(t,n){return t?{message:t}:void s.render("matches/edit.ejs",{message:"",list:n,user:e.user,moment:moment,title:"Matches List"})})}),e.post("/matches/edit/match",function(e,s,t){var n,i,a,d;if(i=e.body.list_id,d=e.body.player_status,n=e.body.full_name,a=new ObjectId(e.body.player_id),"remove"===d)return void List.findByIdAndUpdate({_id:i},{$pull:{names:{full_name:n,player_id:new ObjectId(a)}}},function(e,t){return e?s.status(422).json(e):List.findOne({_id:i,"names.full_name":n},function(t,n){return e?s.status(422).json(t):s.status(200).json(n)})})}),e.post("/matches/create",isLoggedIn,function(e,s,t){var n,i,a,d,o,r,u;return i=e.body.names,u="true"===i?[{player_id:new ObjectId(e.user.id),datetime:"date",last_name:e.user.facebook.last_name,first_name:e.user.facebook.first_name,full_name:e.user.facebook.first_name+" "+e.user.facebook.last_name,phone:e.user.phone,status:"playing"}]:[],a=e.body.list_date,d=e.body.list_size,o=e.body.list_status,n="",r=new List({list_date:a,list_size:d,names:u,list_status:o,date:Date.now(),url:uuid.v1()}),r.save(function(e,t,n){var i;if(i=require("util"),e)console.log(e),"object"==typeof e?s.json({message:"Object already exists"}):s.json({message:e});else{if(n>0)return s.json({message:"ok"});s.json({message:String(n)+" rows affected"})}})}),e.post("/matches/update",isLoggedIn,function(e,s,t){var n,i,a,d;return i=e.body.list_id,n=e.body.list_date,d=e.body.list_status,a=e.body.list_size,""===i||""===d||""===n||a<0?void s.json({message:"wrong params"}):List.update({_id:i},{$set:{list_size:a,list_status:d,list_date:n}},function(e,t){return e?s.json({message:e}):t>0?s.json({message:"ok"}):void s.json({message:String(t)+" rows affected"})})})};
var List,ObjectId,Penalty,User,UserPenalty,_,addMatchToUserList,isLoggedIn,moment,uuid;List=require("../models/list"),User=require("../models/user"),moment=require("moment"),uuid=require("node-uuid"),_=require("underscore"),Penalty=require("../models/penalty"),UserPenalty=require("../models/user_penalty"),ObjectId=require("mongodb").ObjectID,isLoggedIn=function(e,t,s){return e.isAuthenticated()?s():void t.redirect("/")},addMatchToUserList=function(e,t,s,n){return"push"===s?User.update({_id:e.id},{$addToSet:{matches:t}},function(e,t){return e?{message:e}:t>0?{message:"ok"}:{message:"0 rows affected"}}):User.findByIdAndUpdate({_id:e.id},{$pull:{matches:t}},function(e,t){return e?{message:e}:{message:t}})},module.exports=function(e){e.get("/matches",isLoggedIn,function(e,t){List.find({},function(s,n){return s?console.log(s):void t.render("matches/index.ejs",{message:e.flash("loginMessage"),lists:n,user:e.user,moment:moment,title:"Matches List"})})}),e.post("/matches/views/playerslist",isLoggedIn,function(e,t){return List.findOne({_id:e.body.list_id},function(s,n){return s?void t.send(s):void t.render("matches/names/names_list.ejs",{message:e.flash("loginMessage"),list:n,user:e.user,moment:moment,title:"Matches index"})})}),e.post("/matches/addusertomatch",function(e,t){var s;return s=e.body.list_id,User.find({},function(e,n){return _.each(n,function(e){List.update({_id:s},{$addToSet:{names:{player_id:e._id,datetime:"",last_name:e.facebook.last_name,first_name:e.facebook.first_name,full_name:e.facebook.full_name,phone:e.phone,status:"playing"}}},function(e,t){})}),t.send("ok")})}),e.post("/matches/participate",isLoggedIn,function(e,t){var s,n,i,a,o,d,r;return r=new ObjectId(e.user.id),s="date",a=e.user.facebook.last_name,n=e.user.facebook.first_name,i=e.user.facebook.first_name+" "+e.user.facebook.last_name,o=e.body.list_id,d=e.user.phone,"true"===e.body.player_status?(addMatchToUserList(e.user,o,"push"),List.update({_id:o},{$addToSet:{names:{player_id:r,datetime:s,last_name:a,first_name:n,full_name:i,status:"playing",phone:d}}},function(e,s){return e?t.send("err: "+String(e)):s>0?t.json({message:"ok"}):void t.json({message:"0 rows affected"})})):List.findOne({_id:o},function(s,n){var a,d,r;a=moment(),r=moment(n.list_date,"x"),d=a.diff(r,"minutes"),d>-360&&(Penalty.findOne({description:"Player removed name from list less than 6 hours before match starting"},function(e,t){return e?console.log(e):console.log(t)}),console.log(d)),addMatchToUserList(e.user,o,"pull"),List.findByIdAndUpdate({_id:o},{$pull:{names:{full_name:i}}},function(e,s){return e?t.send("err: "+String(e)):t.send(s)})})}),e.get("/matches/match/:listid",isLoggedIn,function(e,t){var s;s=e.params.listid,List.find({_id:s,names:{$elemMatch:{full_name:e.user.facebook.full_name}}},function(n,i){var a;return a=!(i.length<=0),List.findOne({_id:s},function(s,n){return s?void console.log(s):void t.render("matches/match_details.ejs",{message:e.flash("loginMessage"),list:n,match_date:moment(n.date).format("dddd, MMMM Do YYYY, h : mm : ss a"),user:e.user,player_on_list:a,moment:moment,disabled:"deactivate"===n.list_status?"disabled":"",title:"Match"})})})}),e.get("/matches/match/details/:listid",isLoggedIn,function(e,t){List.findOne({_id:e.params.listid},function(s,n){return s?void console.log(s):void t.render("matches/match_list_details.ejs",{message:e.flash("loginMessage"),list:n,match_date:moment(n.date).format("dddd, MMMM Do YYYY, h : mm : ss a"),user:e.user,title:"Match: details"})})}),e.get("/matches/create",isLoggedIn,function(e,t){t.render("matches/create.ejs",{title:"Create a match"})}),e.get("/matches/edit",isLoggedIn,function(e,t){return List.find({},function(s,n){return s?void t.send(s):void t.render("matches/list.ejs",{message:e.flash("loginMessage"),lists:n,user:e.user,moment:moment,title:"Matches index"})})}),e.get("/matches/edit/:listid",isLoggedIn,function(e,t,s){var n;return n=e.params.listid,List.findOne({_id:n},{},function(s,n){return s?{message:s}:void t.render("matches/edit.ejs",{message:"",list:n,user:e.user,moment:moment,title:"Matches List"})})}),e.post("/matches/edit/match",function(e,t,s){var n,i,a,o;if(i=e.body.list_id,o=e.body.player_status,n=e.body.full_name,a=new ObjectId(e.body.player_id),"remove"===o)return void List.findByIdAndUpdate({_id:i},{$pull:{names:{full_name:n,player_id:new ObjectId(a)}}},function(e,s){return e?t.status(422).json(e):List.findOne({_id:i,"names.full_name":n},function(s,n){return e?t.status(422).json(s):t.status(200).json(n)})})}),e.post("/matches/create",isLoggedIn,function(e,t,s){var n,i,a,o,d,r,u;return i=e.body.names,u="true"===i?[{player_id:new ObjectId(e.user.id),datetime:"date",last_name:e.user.facebook.last_name,first_name:e.user.facebook.first_name,full_name:e.user.facebook.first_name+" "+e.user.facebook.last_name,phone:e.user.phone,status:"playing"}]:[],a=e.body.list_date,o=e.body.list_size,d=e.body.list_status,n="",r=new List({list_date:a,list_size:o,names:u,list_status:d,date:Date.now(),url:uuid.v1()}),r.save(function(e,s,n){var i;if(i=require("util"),e)console.log(e),"object"==typeof e?t.json({message:"Object already exists"}):t.json({message:e});else{if(n>0)return t.json({message:"ok"});t.json({message:String(n)+" rows affected"})}})}),e.post("/matches/update",isLoggedIn,function(e,t,s){var n,i,a,o;return i=e.body.list_id,n=e.body.list_date,o=e.body.list_status,a=e.body.list_size,""===i||""===o||""===n||a<0?void t.json({message:"wrong params"}):List.update({_id:i},{$set:{list_size:a,list_status:o,list_date:n}},function(e,s){return e?t.json({message:e}):s>0?t.json({message:"ok"}):void t.json({message:String(s)+" rows affected"})})})};
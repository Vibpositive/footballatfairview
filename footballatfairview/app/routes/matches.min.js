var List,ObjectId,Penalty,Q,User,UserPenalty,_,addMatchToUserList,addPenaltyToUser,f_addUserToMatch,f_removePenaltyFromUser,f_updateListbyStatus,isLoggedIn,moment,uuid;List=require("../models/list"),User=require("../models/user"),moment=require("moment"),uuid=require("node-uuid"),_=require("underscore"),Penalty=require("../models/penalty"),UserPenalty=require("../models/user_penalty"),ObjectId=require("mongodb").ObjectID,Q=require("q"),isLoggedIn=function(e,t,s){return e.isAuthenticated()?s():void t.redirect("/")},addMatchToUserList=function(e,t,s,n){return s===!0?User.update({_id:e.id},{$addToSet:{matches:t}},function(e,t){return e?{message:e}:t>0?{message:"ok"}:{message:"0 rows affected"}}):User.findByIdAndUpdate({_id:e.id},{$pull:{matches:t}},function(e,t){return e?{message:e}:{message:t}})},addPenaltyToUser=function(e,t,s,n){},f_updateListbyStatus=function(e,t,s){var n;return n=Q.defer(),console.log("params",s),List.update({_id:e,names:{$elemMatch:{status:t}}},{$set:{"names.$.player_id":s.player_id,"names.$.datetime":s.datetime,"names.$.last_name":s.last_name,"names.$.first_name":s.first_name,"names.$.full_name":s.full_name,"names.$.phone":s.phone,"names.$.status":"playing"}},function(e,t){return e&&(console.log(e),n.resolve(e)),console.log("numAffected",t),n.resolve(t)}),n.promise},f_addUserToMatch=function(e,t){var s,n,a,i,d,r,o;return n=Q.defer(),o=new ObjectId(t.user.id),s="date",d=t.user.facebook.last_name,a=t.user.facebook.first_name,i=t.user.facebook.first_name+" "+t.user.facebook.last_name,e=t.body.list_id,r=t.user.phone,List.update({_id:e},{$addToSet:{names:{player_id:o,datetime:s,last_name:d,first_name:a,full_name:i,status:"playing",phone:r}}},function(e,t){return e&&n.resolve(e),n.resolve(t)}),n.promise},f_removePenaltyFromUser=function(e){var t;return console.log("f_removePenaltyFromUser",f_removePenaltyFromUser),t=Q.defer(),List.aggregate({$match:{$and:[{_id:ObjectId(e)}]}},{$project:{names:{$filter:{input:"$names",as:"name",cond:{$and:[{$eq:["$$name.player_id",ObjectId(player_id)]}]}}},_id:0}},function(e,s){var n;return e&&(console.log(e),t.resolve(e)),n=s[0].names[0].penalty_id,t.resolve(n),UserPenalty.findByIdAndRemove({_id:ObjectId(n)},function(e,t){})}),t.promise},module.exports=function(e){return e.post("/matches/addusertomatch2",function(e,t){return f_addUserToMatch("579fb22c881894cf51450dbc").then(function(e){return t.send({itemModified:e})})}),e.get("/matches",isLoggedIn,function(e,t){List.find({},function(s,n){return s?console.log(s):void t.render("matches/index.ejs",{message:e.flash("loginMessage"),lists:n,user:e.user,moment:moment,title:"Matches List"})})}),e.post("/matches/views/playerslist",isLoggedIn,function(e,t){List.findOne({_id:e.body.list_id},function(s,n){return s?void t.send(s):void t.render("matches/names/names_list.ejs",{message:e.flash("loginMessage"),list:n,user:e.user,moment:moment,title:"Matches index"})})}),e.post("/matches/participate",isLoggedIn,function(e,t){var s,n,a,i,d;return a=new ObjectId(e.user.id),n=e.body.list_id,s=!1,i=!1,d={},d.player_id=new ObjectId(e.user.id),d.datetime="date",d.last_name=e.user.facebook.last_name,d.first_name=e.user.facebook.first_name,d.full_name=e.user.facebook.first_name+" "+e.user.facebook.last_name,d.phone=e.user.phone,"true"===e.body.player_status?(console.log("req.body.player_status == 'true'"),List.findOne({_id:n,"names.player_id":a},function(a,r){return a?(console.log(a),a):(r?_.each(r.names,function(t){if(String(t.player_id)===String(e.user.id)){if(String(t.status)!==String("blocked"))return i=!0;s=!0}}):i=!0,s||i!==!0?void 0:(f_updateListbyStatus(n,"blocked",d).then(function(e){return a?(console.log(a),t.send(a)):(1!==e&&f_addUserToMatch(n).then(function(e){return t.send("ok")}),f_removePenaltyFromUser(n.then(function(e){return console.log("data",e),console.log("4"),t.send("ok")})),console.log("2"),t.send("ok"))}),addMatchToUserList(e.user,n,!0)))})):List.findOne({_id:n},function(s,i){var d,r,o,l,u;return d=moment(),l=moment(i.list_date,"x"),r=d.diff(l,"minutes"),u=9999,o=!1,r>-360?List.findOne({_id:n,names:{$elemMatch:{player_id:a}}},function(s,d){var r,l;return s?(console.log(s),t.send(s)):(l=d.names.length,r=l>=i.list_size,_.each(d.names,function(t,s){if(String(t.player_id)===String(e.user.id)&&(u=s,u>i.list_size))return o=!0}),r===!1||o===!0?(List.findByIdAndUpdate({_id:n},{$pull:{names:{player_id:a}}},function(e,s){return t.send("ok")}),addMatchToUserList(e.user,n,!1)):(Penalty.findOne({description:"Player removed name from list less than 6 hours before match starting"},function(s,i){var d;return s?t.status(422).json(s):(d=new UserPenalty({player_id:e.user.id,penalty_id:i.id,match_id:n}),d.save(function(s,i,r){return s?t.status(422).json(s):(User.update({_id:e.user.id},{$addToSet:{penalties:d._id}},function(e,t){}),List.update({_id:n,names:{$elemMatch:{player_id:a}}},{$set:{"names.$.datetime":"","names.$.last_name":"available","names.$.first_name":"Position","names.$.full_name":"","names.$.phone":"","names.$.status":"blocked","names.$.penalty_id":d._id}},function(e,s){return e?void t.json({message:e}):t.send("ok")}))}))}),addMatchToUserList(e.user,n,!1)))}):(addMatchToUserList(e.user,n,!1),List.findByIdAndUpdate({_id:n},{$pull:{names:{full_name:full_name}}},function(e,s){return e?void t.send("err: "+String(e)):void t.send(s)}))})}),e.get("/matches/match/:list_id",isLoggedIn,function(e,t){var s,n,a,i;s=e.params.list_id,n=e.user._id,a=!1,i=!1,List.aggregate({$match:{$and:[{_id:ObjectId(s)}]}},{$project:{names:{$filter:{input:"$names",as:"name",cond:{$and:[{$eq:["$$name.status","blocked"]},{$eq:["$$name.player_id",ObjectId(n)]}]}}},_id:0}},function(e,t){if(e&&console.log(e),void 0!==t[0].names[0])return a=!0}),List.find({_id:s,names:{$elemMatch:{player_id:ObjectId(e.user.id)}}},function(n,d){return i=!(d.length<=0),List.findOne({_id:ObjectId(s)},function(s,n){return s&&(console.log(s),t.send(s)),t.render("matches/match_details.ejs",{message:e.flash("loginMessage"),list:n,match_date:moment(n.list_date).format("dddd, MMMM Do YYYY, h             : mm : ss a"),user:e.user,player_is_blocked:a,player_is_on_list:i,moment:moment,disabled:"deactivate"===n.list_status?"disabled":"",title:"Match"})})})}),e.post("/matches/match/details/:list_id",function(e,t){var s;return s=!1,List.aggregate({$match:{$and:[{_id:ObjectId(list_id)}]}},{$project:{names:{$filter:{input:"$names",as:"name",cond:{$and:[{$eq:["$$name.status","blocked"]},{$eq:["$$name.player_id",ObjectId(player_id)]}]}}},_id:0}},function(e,t){if(e&&console.log(e),void 0!==t[0].names[0])return s=!0}),List.findOne({_id:ObjectId(list_id)},function(e,s){return e&&(console.log(e),t.send(e)),t.send(s)})}),e.get("/matches/match/details/:list_id",isLoggedIn,function(e,t){List.findOne({_id:ObjectId(e.params.list_id)},function(s,n){return s?console.log("err",s):void t.render("matches/match_list_details.ejs",{message:e.flash("loginMessage"),list:n,match_date:moment(n.list_date).format("dddd, MMMM Do YYYY, h : mm : ss a"),user:e.user,title:"Match: details"})})}),e.get("/matches/create",isLoggedIn,function(e,t){t.render("matches/create.ejs",{title:"Create a match"})}),e.get("/matches/edit",isLoggedIn,function(e,t){return List.find({},function(s,n){return s?void t.send(s):void t.render("matches/list.ejs",{message:e.flash("loginMessage"),lists:n,user:e.user,moment:moment,title:"Matches index"})})}),e.get("/matches/edit/:list_id",isLoggedIn,function(e,t,s){var n;return n=e.params.list_id,List.findOne({_id:n},{},function(s,n){return s?{message:s}:void t.render("matches/edit.ejs",{message:"",list:n,user:e.user,moment:moment,title:"Matches List"})})}),e.post("/matches/edit/match",function(e,t,s){var n,a,i,d;if(a=e.body.list_id,d=e.body.player_status,n=e.body.full_name,i=new ObjectId(e.body.player_id),"remove"===d)return void List.findByIdAndUpdate({_id:a},{$pull:{names:{full_name:n,player_id:new ObjectId(i)}}},function(e,s){return e?t.status(422).json(e):List.findOne({_id:a,"names.full_name":n},function(s,n){return e?t.status(422).json(s):void t.status(200).json(n)})})}),e.post("/matches/create",isLoggedIn,function(e,t,s){var n,a,i,d,r,o,l;return a=e.body.names,"true"===a?l=[{player_id:new ObjectId(e.user.id),datetime:"date",last_name:e.user.facebook.last_name,first_name:e.user.facebook.first_name,full_name:e.user.facebook.first_name+" "+e.user.facebook.last_name,phone:e.user.phone,status:"playing"}]:(l=[],i=e.body.list_date,d=e.body.list_size,r=e.body.list_status,n="",o=new List({list_date:i,list_size:d,names:l,list_status:r,date:Date.now(),url:uuid.v1()}),o.save(function(e,s,n){var a;return a=require("util"),e&&(console.log(e),t.json({message:e})),t.json({message:String(n)+" rows affected"})})),t.send("nothing received")}),e.post("/matches/update",isLoggedIn,function(e,t,s){var n,a,i,d;return a=e.body.list_id,n=e.body.list_date,d=e.body.list_status,i=e.body.list_size,""===a||""===d||""===n||i<0?void t.json({message:"wrong params"}):List.update({_id:a},{$set:{list_size:i,list_status:d,list_date:n}},function(e,s){return e?t.json({message:e}):s>0?void t.json({message:"ok"}):void t.json({message:String(s)+" rows affected"})})})};
var List,ObjectId,Penalty,User,UserPenalty,_,addMatchToUserList,isLoggedIn,moment,uuid;List=require("../models/list"),User=require("../models/user"),moment=require("moment"),uuid=require("node-uuid"),_=require("underscore"),Penalty=require("../models/penalty"),UserPenalty=require("../models/user_penalty"),ObjectId=require("mongodb").ObjectID,isLoggedIn=function(e,t,s){return e.isAuthenticated()?s():void t.redirect("/")},addMatchToUserList=function(e,t,s,n){return"push"===s?User.update({_id:e.id},{$addToSet:{matches:t}},function(e,t){return e?{message:e}:t>0?{message:"ok"}:{message:"0 rows affected"}}):User.findByIdAndUpdate({_id:e.id},{$pull:{matches:t}},function(e,t){return e?{message:e}:{message:t}})},module.exports=function(e){return e.get("/matches",isLoggedIn,function(e,t){List.find({},function(s,n){return s?console.log(s):void t.render("matches/index.ejs",{message:e.flash("loginMessage"),lists:n,user:e.user,moment:moment,title:"Matches List"})})}),e.post("/matches/views/playerslist",isLoggedIn,function(e,t){List.findOne({_id:e.body.list_id},function(s,n){return s?void t.send(s):void t.render("matches/names/names_list.ejs",{message:e.flash("loginMessage"),list:n,user:e.user,moment:moment,title:"Matches index"})})}),e.post("/matches/addusertomatch",function(e,t){var s;return s=e.body.list_id,User.find({},function(e,t){return _.each(t,function(e){List.update({_id:s},{$addToSet:{names:{player_id:e._id,datetime:"",last_name:e.facebook.last_name,first_name:e.facebook.first_name,full_name:e.facebook.full_name,phone:e.phone,status:"playing"}}},function(e,t){})})})}),e.post("/matches/participate",isLoggedIn,function(e,t){var s,n,a,i,o,d,r,u,l;return u=new ObjectId(e.user.id),s="date",o=e.user.facebook.last_name,n=e.user.facebook.first_name,a=e.user.facebook.first_name+" "+e.user.facebook.last_name,d=e.body.list_id,r=e.user.phone,i=!1,l=!1,"true"===e.body.player_status?(console.log("if req.body.player_status =="),List.findOne({_id:d,"names.player_id":u},function(m,c){var f;return m?(console.log(m),m):(c?_.each(c.names,function(t){if(String(t.player_id)===String(e.user.id)){if(String(t.status)!==String("blocked"))return l=!0;i=!0,console.log("setting user as blocked")}}):l=!0,i||l!==!0?void 0:(console.log("updating user"),f={$addToSet:{names:{player_id:u,datetime:s,last_name:o,first_name:n,full_name:a,status:"playing",phone:r}}},List.findOneAndUpdate({_id:d},f,function(e,s){return e?(console.log(e),void next(e)):(console.log(s),t.json({message:"ok"}))}),addMatchToUserList(e.user,d,"push")))})):List.findOne({_id:d},function(s,n){var i,o,r;return i=moment(),r=moment(n.list_date,"x"),o=i.diff(r,"minutes"),o>-360?(List.update({_id:d,names:{$elemMatch:{player_id:u}}},{$set:{"names.$.status":"blocked"}},function(e,s){if(e)return void t.json({message:e})}),Penalty.findOne({description:"Player removed name from list less than 6 hours before match starting"},function(s,n){var a;return s?t.status(422).json(s):(a=new UserPenalty({player_id:e.user.id,penalty_id:n.id,match_id:d}),a.save(function(e,s,n){return e?t.status(422).json(e):t.status(200).json({message:n})}))})):(addMatchToUserList(e.user,d,"pull"),List.findByIdAndUpdate({_id:d},{$pull:{names:{full_name:a}}},function(e,s){return e?void t.send("err: "+String(e)):void t.send(s)}))})}),e.get("/matches/match/:listid",isLoggedIn,function(e,t){var s;s=e.params.listid,List.find({_id:s,names:{$elemMatch:{full_name:e.user.facebook.full_name}}},function(n,a){var i;i=!(a.length<=0),List.findOne({_id:s},function(s,n){return s?void console.log(s):void t.render("matches/match_details.ejs",{message:e.flash("loginMessage"),list:n,match_date:moment(n.date).format("dddd, MMMM Do YYYY, h : mm : ss a"),user:e.user,player_on_list:i,moment:moment,disabled:"deactivate"===n.list_status?"disabled":"",title:"Match"})})})}),e.post("/matches/match/details/:listid",function(e,t){return List.aggregate({$match:{$and:[{_id:ObjectId("57645e6601daabea219c0e37")}]}},{$project:{names:{$filter:{input:"$names",as:"name",cond:{$eq:["$$name.status","playing"]}}},_id:1,list_date:1,list_status:1,list_size:1}},function(e,s){return e&&(console.log(e),t.send(e)),console.log(s),t.send(s)})}),e.get("/matches/match/details/:listid",function(e,t){List.aggregate([{$match:{_id:ObjectId(e.params.listid)}},{$project:{resultado:{$filter:{input:"$names",as:"names",cond:{$eq:["$$names.status","playing"]}}},_id:0}}],function(s,n){return s?console.log("err",s):(console.log(n[0].resultado),void t.render("matches/match_list_details.ejs",{message:e.flash("loginMessage"),list:n[0].resultado,match_date:moment(list.date).format("dddd, MMMM Do YYYY, h : mm : ss a"),user:e.user,title:"Match: details"}))})}),e.get("/matches/create",isLoggedIn,function(e,t){t.render("matches/create.ejs",{title:"Create a match"})}),e.get("/matches/edit",isLoggedIn,function(e,t){return List.find({},function(s,n){return s?void t.send(s):void t.render("matches/list.ejs",{message:e.flash("loginMessage"),lists:n,user:e.user,moment:moment,title:"Matches index"})})}),e.get("/matches/edit/:listid",isLoggedIn,function(e,t,s){var n;return n=e.params.listid,List.findOne({_id:n},{},function(s,n){return s?{message:s}:void t.render("matches/edit.ejs",{message:"",list:n,user:e.user,moment:moment,title:"Matches List"})})}),e.post("/matches/edit/match",function(e,t,s){var n,a,i,o;if(a=e.body.list_id,o=e.body.player_status,n=e.body.full_name,i=new ObjectId(e.body.player_id),"remove"===o)return void List.findByIdAndUpdate({_id:a},{$pull:{names:{full_name:n,player_id:new ObjectId(i)}}},function(e,s){return e?t.status(422).json(e):List.findOne({_id:a,"names.full_name":n},function(s,n){return e?t.status(422).json(s):void t.status(200).json(n)})})}),e.post("/matches/create",isLoggedIn,function(e,t,s){var n,a,i,o,d,r,u;return a=e.body.names,"true"===a?u=[{player_id:new ObjectId(e.user.id),datetime:"date",last_name:e.user.facebook.last_name,first_name:e.user.facebook.first_name,full_name:e.user.facebook.first_name+" "+e.user.facebook.last_name,phone:e.user.phone,status:"playing"}]:(u=[],i=e.body.list_date,o=e.body.list_size,d=e.body.list_status,n="",r=new List({list_date:i,list_size:o,names:u,list_status:d,date:Date.now(),url:uuid.v1()}),console.log("saving a new match"),r.save(function(e,s,n){var a;return a=require("util"),e&&(console.log(e),t.json({message:e})),t.json({message:String(n)+" rows affected"})})),t.send("nothing received")}),e.post("/matches/update",isLoggedIn,function(e,t,s){var n,a,i,o;return a=e.body.list_id,n=e.body.list_date,o=e.body.list_status,i=e.body.list_size,""===a||""===o||""===n||i<0?void t.json({message:"wrong params"}):List.update({_id:a},{$set:{list_size:i,list_status:o,list_date:n}},function(e,s){return e?t.json({message:e}):s>0?void t.json({message:"ok"}):void t.json({message:String(s)+" rows affected"})})})};
var List,ObjectId,Penalty,User,UserPenalty,_,addMatchToUserList,addPenaltyToUser,isLoggedIn,moment,uuid;List=require("../models/list"),User=require("../models/user"),moment=require("moment"),uuid=require("node-uuid"),_=require("underscore"),Penalty=require("../models/penalty"),UserPenalty=require("../models/user_penalty"),ObjectId=require("mongodb").ObjectID,isLoggedIn=function(e,t,s){return e.isAuthenticated()?s():void t.redirect("/")},addMatchToUserList=function(e,t,s,n){return s===!0?User.update({_id:e.id},{$addToSet:{matches:t}},function(e,t){return e?{message:e}:t>0?{message:"ok"}:{message:"0 rows affected"}}):User.findByIdAndUpdate({_id:e.id},{$pull:{matches:t}},function(e,t){return e?{message:e}:{message:t}})},addPenaltyToUser=function(e,t,s,n){},module.exports=function(e){return e.get("/matches",isLoggedIn,function(e,t){List.find({},function(s,n){return s?console.log(s):void t.render("matches/index.ejs",{message:e.flash("loginMessage"),lists:n,user:e.user,moment:moment,title:"Matches List"})})}),e.post("/matches/views/playerslist",isLoggedIn,function(e,t){List.findOne({_id:e.body.list_id},function(s,n){return s?void t.send(s):void t.render("matches/names/names_list.ejs",{message:e.flash("loginMessage"),list:n,user:e.user,moment:moment,title:"Matches index"})})}),e.post("/matches/addusertomatch",function(e,t){var s;return s=e.body.list_id,User.find({},function(e,t){return _.each(t,function(e){List.update({_id:s},{$addToSet:{names:{player_id:e._id,datetime:"",last_name:e.facebook.last_name,first_name:e.facebook.first_name,full_name:e.facebook.full_name,phone:e.phone,status:"playing"}}},function(e,t){})})})}),e.post("/matches/participate",isLoggedIn,function(e,t){var s,n,i,a,d,o,r,l,u;return l=new ObjectId(e.user.id),s="date",d=e.user.facebook.last_name,n=e.user.facebook.first_name,i=e.user.facebook.first_name+" "+e.user.facebook.last_name,o=e.body.list_id,r=e.user.phone,a=!1,u=!1,"true"===e.body.player_status?List.findOne({_id:o,"names.player_id":l},function(m,c){var f;return m?(console.log(m),m):(c?_.each(c.names,function(t){if(String(t.player_id)===String(e.user.id)){if(String(t.status)!==String("blocked"))return u=!0;a=!0,console.log("setting user as blocked")}}):u=!0,a||u!==!0?void 0:(console.log("updating user"),f={$set:{names:[{player_id:l},{datetime:s,last_name:d,first_name:n,full_name:i,status:"playing",phone:r}]}},List.update({_id:o,names:{$elemMatch:{status:"blocked"}}},{$set:{"names.$.player_id":l,"names.$.datetime":s,"names.$.last_name":d,"names.$.first_name":n,"names.$.full_name":i,"names.$.phone":r,"names.$.status":"playing"}},function(e,a){return e?(console.log(e),t.send(e)):1!==a?List.update({_id:o},{$addToSet:{names:{player_id:l,datetime:s,last_name:d,first_name:n,full_name:i,status:"playing",phone:r}}},function(e,s){e&&t.send("err: "+String(e)),t.send("ok")}):(List.update({_id:o,names:{$elemMatch:{player_id:l}}},{$unset:{"names.$.penalty_id":!0}},function(e,t){if(e)return console.log(e)}),t.send("ok"))}),addMatchToUserList(e.user,o,!0)))}):List.findOne({_id:o},function(s,n){var a,d,r,u,m;return a=moment(),u=moment(n.list_date,"x"),d=a.diff(u,"minutes"),m=9999,r=!1,d>-360?List.findOne({_id:o,names:{$elemMatch:{player_id:l}}},function(s,i){var a,d;return s?(console.log(s),t.send(s)):(d=i.names.length,a=d>=n.list_size,console.log("is_there_waiting_list",a),console.log("users_playing",d),console.log("list.list_size",n.list_size),_.each(i.names,function(t,s){if(String(t.player_id)===String(e.user.id)&&(m=s,m>n.list_size))return r=!0}),a===!1||r===!0?(List.findByIdAndUpdate({_id:o},{$pull:{names:{player_id:l}}},function(e,s){return t.send("ok")}),addMatchToUserList(e.user,o,!1)):(Penalty.findOne({description:"Player removed name from list less than 6 hours before match starting"},function(s,i){var a;return s?t.status(422).json(s):(a=new UserPenalty({player_id:e.user.id,penalty_id:i.id,match_id:o}),a.save(function(s,i,d){return s?t.status(422).json(s):(console.log(a._id),User.update({_id:e.user.id},{$addToSet:{penalties:a._id}},function(e,t){return console.log("numAffected",t)}),List.update({_id:o,names:{$elemMatch:{player_id:l}}},{$set:{"names.$.datetime":"","names.$.last_name":"available","names.$.first_name":"Position","names.$.full_name":"","names.$.phone":"","names.$.status":"blocked","names.$.penalty_id":a._id}},function(e,s){return console.log("user_index",m,"list.list_size",n.list_size),console.log("is_user_on_waiting_list",String(r)),e?void t.json({message:e}):t.send("ok")}))}))}),addMatchToUserList(e.user,o,!1)))}):(addMatchToUserList(e.user,o,!1),List.findByIdAndUpdate({_id:o},{$pull:{names:{full_name:i}}},function(e,s){return e?void t.send("err: "+String(e)):void t.send(s)}))})}),e.get("/matches/match/:list_id",isLoggedIn,function(e,t){var s,n,i,a;s=e.params.list_id,n=e.user._id,i=!1,a=!1,List.aggregate({$match:{$and:[{_id:ObjectId(s)}]}},{$project:{names:{$filter:{input:"$names",as:"name",cond:{$and:[{$eq:["$$name.status","blocked"]},{$eq:["$$name.player_id",ObjectId(n)]}]}}},_id:0}},function(e,t){if(e&&console.log(e),console.log(t),void 0!==t[0].names[0])return i=!0}),List.find({_id:s,names:{$elemMatch:{player_id:ObjectId(e.user.id)}}},function(n,d){return console.log(d),a=!(d.length<=0),List.findOne({_id:ObjectId(s)},function(s,n){return s&&(console.log(s),t.send(s)),t.render("matches/match_details.ejs",{message:e.flash("loginMessage"),list:n,match_date:moment(n.list_date).format("dddd, MMMM Do YYYY, h             : mm : ss a"),user:e.user,player_is_blocked:i,player_is_on_list:a,moment:moment,disabled:"deactivate"===n.list_status?"disabled":"",title:"Match"})})})}),e.post("/matches/match/details/:list_id",function(e,t){var s;return s=!1,List.aggregate({$match:{$and:[{_id:ObjectId(list_id)}]}},{$project:{names:{$filter:{input:"$names",as:"name",cond:{$and:[{$eq:["$$name.status","blocked"]},{$eq:["$$name.player_id",ObjectId(player_id)]}]}}},_id:0}},function(e,t){if(e&&console.log(e),void 0!==t[0].names[0])return s=!0}),List.findOne({_id:ObjectId(list_id)},function(e,s){return e&&(console.log(e),t.send(e)),console.log(s),t.send(s)})}),e.get("/matches/match/details/:list_id",isLoggedIn,function(e,t){List.findOne({_id:ObjectId(e.params.list_id)},function(s,n){return s?console.log("err",s):(console.log(n),void t.render("matches/match_list_details.ejs",{message:e.flash("loginMessage"),list:n,match_date:moment(n.list_date).format("dddd, MMMM Do YYYY, h : mm : ss a"),user:e.user,title:"Match: details"}))})}),e.get("/matches/create",isLoggedIn,function(e,t){t.render("matches/create.ejs",{title:"Create a match"})}),e.get("/matches/edit",isLoggedIn,function(e,t){return List.find({},function(s,n){return s?void t.send(s):void t.render("matches/list.ejs",{message:e.flash("loginMessage"),lists:n,user:e.user,moment:moment,title:"Matches index"})})}),e.get("/matches/edit/:list_id",isLoggedIn,function(e,t,s){var n;return n=e.params.list_id,List.findOne({_id:n},{},function(s,n){return s?{message:s}:void t.render("matches/edit.ejs",{message:"",list:n,user:e.user,moment:moment,title:"Matches List"})})}),e.post("/matches/edit/match",function(e,t,s){var n,i,a,d;if(i=e.body.list_id,d=e.body.player_status,n=e.body.full_name,a=new ObjectId(e.body.player_id),"remove"===d)return void List.findByIdAndUpdate({_id:i},{$pull:{names:{full_name:n,player_id:new ObjectId(a)}}},function(e,s){return e?t.status(422).json(e):List.findOne({_id:i,"names.full_name":n},function(s,n){return e?t.status(422).json(s):void t.status(200).json(n)})})}),e.post("/matches/create",isLoggedIn,function(e,t,s){var n,i,a,d,o,r,l;return i=e.body.names,"true"===i?l=[{player_id:new ObjectId(e.user.id),datetime:"date",last_name:e.user.facebook.last_name,first_name:e.user.facebook.first_name,full_name:e.user.facebook.first_name+" "+e.user.facebook.last_name,phone:e.user.phone,status:"playing"}]:(l=[],a=e.body.list_date,d=e.body.list_size,o=e.body.list_status,n="",r=new List({list_date:a,list_size:d,names:l,list_status:o,date:Date.now(),url:uuid.v1()}),console.log("saving a new match"),r.save(function(e,s,n){var i;return i=require("util"),e&&(console.log(e),t.json({message:e})),t.json({message:String(n)+" rows affected"})})),t.send("nothing received")}),e.post("/matches/update",isLoggedIn,function(e,t,s){var n,i,a,d;return i=e.body.list_id,n=e.body.list_date,d=e.body.list_status,a=e.body.list_size,""===i||""===d||""===n||a<0?void t.json({message:"wrong params"}):List.update({_id:i},{$set:{list_size:a,list_status:d,list_date:n}},function(e,s){return e?t.json({message:e}):s>0?void t.json({message:"ok"}):void t.json({message:String(s)+" rows affected"})})})};